kind: pipeline
type: docker
name: default

clone:
  disable: true

steps:
- name: build
  image: ruby:3.4
  environment:
    JEKYLL_ENV: production
    BUNDLE_PATH: /drone/src/vendor/bundle
  commands:
    - "git -c http.sslVerify=false -c http.extraHeader=\"Host: git.hmcl.net\" clone --branch main --depth 1 https://host.docker.internal/huanghongxun/HMCL-docs.git HMCL-docs"
    - cd HMCL-docs
    - bundle config mirror.https://rubygems.org https://mirrors.cloud.tencent.com/rubygems
    - bundle install --verbose
    - echo "cache_dir: /drone/src/.jekyll-cache" > /drone/src/_cache_config.yml
    - bundle exec jekyll build --trace --verbose --destination /drone/src/_site --config /drone/src/HMCL-docs/_config.yml,/drone/src/_cache_config.yml
  volumes:
  - name: dist
    path: /drone/src/_site
  - name: vendor
    path: /drone/src/vendor
  - name: jekyll-cache
    path: /drone/src/.jekyll-cache
  when:
    branch: [main]

volumes:
- name: dist
  host:
    path: /home/ubuntu/docs.hmcl.net/www
- name: vendor
  host:
    path: /home/ubuntu/docs.hmcl.net/cache/vendor
- name: jekyll-cache
  host:
    path: /home/ubuntu/docs.hmcl.net/cache/jekyll-cache
